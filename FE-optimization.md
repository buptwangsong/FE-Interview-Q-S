## 前端优化

日后整理，参考：

[前端工程与性能优化](https://github.com/fouber/blog/issues/3)

[雅虎web优化14条规则]（https://www.jianshu.com/p/603d9ac62ba6）

> 前端是一种远程部署，运行时增量下载的GUI软件

前端应用没有安装过程，其所需程序资源都部署在远程服务器上，用户使用浏览器访问不同的页面来加载不同的资源，随着访问页面的增加，渐进式的将整个程序加载到本地，
`增量下载`是前端在工程上区别于GUI软件的根本原因。

根据`增量原则`，我们应该精心规划每个页面的资源加载策略，使得用户访问那个页面，就能按需加载该页面所需资源，没有访问的页面不加载，加载过的资源可以缓存复用，
最终带来流畅的用户体验

`增量原则`引申出的前端优化技巧几乎成为web性能优化的核心，有加载相关的*按需加载*、*延迟加载*、*预加载*、*请求合并*策略等等，有缓存相关的*浏览器缓存*、*缓存更新*、*缓存共享*、*非覆盖式发布方案*等等。

1. 禁止使用iframe

* iframe 会阻塞主页面的onload事件

* 搜索引擎的检索程序无法解读这种页面

* iframe 与主页面共享连接池，而浏览器对相同域的链接有数量限制，所以会影响主页面的并行加载

* 如果非得要使用iframe，最好是用js动态的给iframe 设置src 属性，可以绕开以上问题

2. 禁止使用gif图片实现loading效果（降低CPU消耗，提升渲染性能）

3. 使用CSS3代替JS动画（尽可能的避免重绘重排和回流）

4. 对于一些小的图标，可以使用base64编码，减少网路请求。不建议大图片使用，太耗费CPU

5. 页面头部的<script>标签会阻塞页面加载解析与渲染（js线程与渲染线程是共用一个线程的）
  
6. 合理设置缓存（服务器端缓存：CDN，浏览器缓存：强缓存和若缓存）

7. 用innerHTML代替dom操作，减少dom操作次数。

8. 缓存ajax的请求结果，减少请求数

9. 缓存dom的查询结果，减少dom操作

10. 避免使用CSS expression

*统一思路*
> 普通网站优化的统一思路：尽量向前端优化，减少数据库操作，减少磁盘IO
> 向前端优化是指，在不影响功能与体验的前提下，能在浏览器完成的就不要再服务器端完成。
> 能在缓存服务器上取得的就不要到应用服务器

### 雅虎web优化14条规则

1. 减少 HTTP请求

> 减少HTTP请求的方式有很多，常用的有CSS sprites、合并CSS和js文件、本地图片等。这条规则可以改善首次访问网站的响应时间。
>> `css sprites` : 一种网页图片应用处理方式，他允许将一个网页所涉及的所有零星图片都包含到一张大图中去，这样一来，当访问网页时，图片就不会像以前那样一副一副的慢慢显示出来。对于当前的网络速度而言，不高于200kb的单张图片的载入时间基本上差不多的。

2. 使用CDN

> 当显示一个网页时，绝大多数的响应时间都花在了加载网页中的资源上，只有少量时间用来下载html文档。如果应用服务器离用户很近，则一次http请求的响应时间就会很短。CDN即内容分发网络，是一组分布在不同地理位置上的web服务器，每个web服务器都拥有网站资源的一份拷贝，当用户访问网站时，可以从离用户最近的web服务器上加载所需的资源。

3. 添加expires 头

> expires 是HTTP1.0提出的一个表示资源过期时间的header，它表示的是绝对时间，由服务端返回。当服务器的时间与客户端相差很大时，那是误差就会很大，HTTP1.1提出的cache-control：max-age= 相对时间/s 主要是用来解决这个问题。

4. 启用Gzip

> 客户端可以通过HTTP 请求头中的 Accept-Encoding来标识对压缩的支持（Accept-Encoding:gzip/compress/deflate/br），服务器看到请求中有这个头，就会使用客户端列出的一种压缩方法来压缩响应。大多数网站使用gzip来压缩html

5. 将CSS放在文档的顶部

> 将CSS放在文档的底部会发生无样式闪烁，因为浏览器会先加载html，再加载CSS，会出现一段没有任何样式的白屏时间，而将css放在底部不会出现这个问题。

6. 将script放在文档顶部

> 由于浏览器是单线程的，js引擎和渲染引擎共用一个线程，将js脚本放在文档的顶部，浏览器对js的加载和解析会阻塞渲染引擎，停止页面渲染。此外，http1.1规范建议浏览器对每个主机开启2个并行下载，而一些高版本的浏览器（firefox/chrome）支持的并行下载数为6个，js 会阻塞并行下载。

7. 避免 CSS expression

> CSS具备求值计算能力，而页面发生 repaint时， CSS expression会影响页面的加载时间

8. 使用外联的CSS和JS

> 实现样式、结构和行为的分离，减小整个页面的大小，同时有利于文件缓存。

9. 减小DNS查询

> 通过设置HTTP请求头 Connection: Keep-Alive（close：关闭），和使用适当数量的域名，来减少DNS查询

10. 精简JS和CSS 文件

> 进行代码混淆可以压缩文件的大小，使用grunt和gulp 等构建工具可以自动化的完成

11. 避免重定向

> 重定向将一个url重新路由到另一个url. 重定向有多重，比如，301--永久重定向，302--临时重定向， 304--not modified。在URL的结尾处加上斜线（/），可以避免一部分重定向。

12. 移除重复的脚本

13. 配置 Etag

> Etag 是资源在服务器的唯一标识（生成规则由服务器决定），默认是对文件的索引节点（INode）、大小（size）、最后修改时间（mtime）进行hash得到的。
> Etag 是协商缓存的的一个请求头标志，主要是用来解决 Last-Modified 最大精度为秒所带来的问题

14. 缓存AJAX请求


## 总结一下

* 代码层面

> 1. 避免使用CSS表达式，避免使用高级选择器，避免使用统配选择器

> 2. 避免使用with(会创建自己的作用域，延长作用域链)

> 3. 多个变量合并声明

> 4. 避免全局全局查找

> 5. 少用全局变量

> 6. 使用setTimeout代替 setInterval,避免页面市区响应

> 7. 尽量使用CSS3动画，开启硬件加速，适当使用touch事件代替click事件

* 缓存利用

> 1. 缓存AJAX请求结果

> 2. 使用CDN

> 3. 使用外部CSS和js文件以便缓存

> 4. 浏览器缓存，配置强缓存和协商缓存，

> 5. 减少DNS查询

> 6. 缓存更新

> 7. 缓存共享

* 请求数量

> 1. 合并CSS和JS

> 2. 使用CSS sprite

> 3. 首屏外资源按需加载

> 4. 静态资源延迟加载

> 5. 预加载

* 请求带宽

> 1. 开启Gzip

> 2. 文件压缩

